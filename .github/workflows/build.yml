name: Sprout Build (V2.5.0)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Prevent duplicate runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================
  # BUILD FOR LINUX
  # ==========================================
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install Linux build dependencies required for Flutter + Rust
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libx11-dev \
            pkg-config \
            cmake \
            ninja-build \
            libblkid-dev \
            liblzma-dev \
            clang \
            libglu1-mesa \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev

      # Set up Rust toolchain
      - name: Set up Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      # Cache Rust dependencies
      - name: Cache Rust
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      # Enable Linux desktop support
      - name: Enable Linux support
        run: flutter config --enable-linux-desktop

      # Get Flutter dependencies
      - name: Get Flutter dependencies
        run: |
          cd flutter
          flutter pub get

      # Build Rust library first (required for flutter_rust_bridge)
      - name: Build Rust library
        run: |
          cd rust/sprout_compiler
          cargo build --release
          # Copy the built library to where Flutter expects it
          mkdir -p ../../flutter/linux/rust
          cp target/release/libsprout_compiler.so ../../flutter/linux/rust/ 2>/dev/null || true

      # Build Flutter for Linux
      - name: Build Flutter Linux
        run: |
          cd flutter
          flutter build linux --release

      # Upload build artifacts
      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: sprout-linux-build
          path: flutter/build/linux/x64/release/bundle/

  # ==========================================
  # BUILD FOR ANDROID
  # ==========================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Java (required for Android)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # Set up Rust with Android targets
      - name: Set up Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      # Cache Rust dependencies
      - name: Cache Rust
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-android-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-android-cargo-

      # Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      # Enable Android support
      - name: Enable Android support
        run: flutter config --enable-android

      # Accept Android licenses
      - name: Accept Android licenses
        run: yes | flutter doctor --android-licenses || true

      # Get Flutter dependencies
      - name: Get Flutter dependencies
        run: |
          cd flutter
          flutter pub get

      # Build Rust for Android (using cargo-ndk or manual build)
      - name: Build Rust for Android
        run: |
          cd rust/sprout_compiler
          cargo install cargo-ndk
          cargo ndk -t armeabi-v7a -t arm64-v8a -t x86 -t x86_64 build --release

      # Build Flutter APK
      - name: Build Flutter APK
        run: |
          cd flutter
          flutter build apk --release

      # Build Flutter App Bundle
      - name: Build Flutter App Bundle
        run: |
          cd flutter
          flutter build appbundle --release

      # Upload artifacts
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: sprout-android-apk
          path: flutter/build/app/outputs/flutter-apk/app-release.apk

      - name: Upload Android AAB
        uses: actions/upload-artifact@v4
        with:
          name: sprout-android-aab
          path: flutter/build/app/outputs/bundle/release/app-release.aab

  # ==========================================
  # BUILD FOR WEB
  # ==========================================
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Rust with wasm target
      - name: Set up Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      # Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      # Enable web support
      - name: Enable web support
        run: flutter config --enable-web

      # Get Flutter dependencies
      - name: Get Flutter dependencies
        run: |
          cd flutter
          flutter pub get

      # Build Rust for WebAssembly
      - name: Build Rust for WASM
        run: |
          cd rust/sprout_compiler
          cargo build --target wasm32-unknown-unknown --release

      # Build Flutter web
      - name: Build Flutter Web
        run: |
          cd flutter
          flutter build web --release

      # Upload artifacts
      - name: Upload Web build
        uses: actions/upload-artifact@v4
        with:
          name: sprout-web-build
          path: flutter/build/web/

  # ==========================================
  # RUN TESTS
  # ==========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [build-linux]  # Run after build to ensure everything compiles
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev pkg-config cmake ninja-build

      # Set up Rust
      - name: Set up Rust
        uses: dtolnay/rust-action@stable

      # Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      # Get dependencies
      - name: Get dependencies
        run: |
          cd flutter
          flutter pub get

      # Run Rust tests
      - name: Run Rust tests
        run: |
          cd rust/sprout_compiler
          cargo test

      # Run Flutter tests
      - name: Run Flutter tests
        run: |
          cd flutter
          flutter test
          
